<!DOCTYPE html>
<html lang="fr" style="margin:0;padding:0;width:100%;height:100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facture {{ invoice.invoice_number }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary: #000000;
            --secondary: #4b5563;
            --muted: #9ca3af;
            --border: #e5e7eb;
            --bg-soft: #f8fafc;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            font-size: 10pt;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-controls { position: fixed; top: 20px; z-index: 1000; display: flex; gap: 10px; }
        .btn-action { padding: 10px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .btn-print { background: #000; color: #fff; }
        .btn-return { background: #fff; color: #000; border: 1px solid #e2e8f0; }

        .container-a4 {
            width: 210mm;
            min-height: 297mm;
            background: #fff;
            padding: 8mm 15mm; /* Réduit le padding haut/bas de 15mm à 8mm */
            margin: 60px 0;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @media print {
            body { background: #fff; }
            .container-a4 { margin: 0; box-shadow: none; width: 210mm; height: 297mm; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 0; }
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end; /* Changé de flex-start pour gagner de la place */
            border-bottom: 2px solid #000;
            padding-bottom: 15px; /* Réduit de 30px */
            margin-bottom: 25px; /* Réduit de 40px */
        }

        .brand h1 { font-size: 28px; font-weight: 900; letter-spacing: -0.05em; text-transform: uppercase; margin-bottom: 2px; } /* Réduit de 32px */
        .brand p { font-size: 9px; color: var(--secondary); text-transform: uppercase; letter-spacing: 0.1em; }

        .doc-meta {
            text-align: right;
            background: var(--bg-soft);
            padding: 12px 20px; /* Réduit de 20px 30px */
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        .doc-title { font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 2px; } /* Réduit */
        .doc-id { font-size: 13px; font-weight: 600; color: var(--secondary); margin-bottom: 4px; }
        .doc-date { font-size: 10px; font-weight: 500; color: var(--muted); }

        /* BILLING INFO */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px; /* Réduit de 60px */
            margin-bottom: 30px; /* Réduit de 50px */
        }

        .info-section-title {
            font-size: 8.5px; /* Réduit */
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--muted);
            margin-bottom: 10px; /* Réduit */
            padding-bottom: 5px; /* Réduit */
            border-bottom: 1px solid var(--border);
        }

        .client-name { font-size: 16px; font-weight: 800; margin-bottom: 5px; color: #000; } /* Réduit */
        .client-details p { font-size: 11px; color: var(--secondary); margin-bottom: 2px; }

        .payment-card {
            background: var(--bg-soft);
            padding: 15px; /* Réduit */
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .payment-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 11px; } /* Réduit */

        /* TABLE */
        .items-container { flex: 1; }
        table { width: 100%; border-collapse: collapse; }
        thead th {
            background: #000;
            color: #fff;
            padding: 10px 15px; /* Réduit */
            font-size: 9px; /* Réduit */
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-align: left;
        }
        tbody td {
            padding: 10px 15px; /* Réduit de 15px */
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .col-desc { width: 50%; }
        .col-qty { width: 10%; text-align: center; }
        .col-price { width: 20%; text-align: right; }
        .col-total { width: 20%; text-align: right; font-weight: 700; }

        .item-name { font-weight: 700; font-size: 12px; margin-bottom: 2px; color: #000; } /* Réduit */
        .item-imei { font-family: 'Courier New', monospace; font-size: 9px; color: var(--secondary); }

        /* TOTALS */
        .summary-block {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px; /* Encore réduit */
            margin-bottom: 15px; /* Encore réduit */
        }
        .totals-table { width: 300px; } /* Réduit de 320px */
        .total-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; } /* Encore réduit */
        .total-row.grand {
            border-top: 2px solid #000;
            margin-top: 5px;
            padding-top: 10px;
            font-size: 18px; /* Réduit de 20px */
            font-weight: 900;
            color: #000;
        }
        .total-row.highlight { color: #059669; font-weight: 700; }

        /* SIGNATURE */
        .signature-area {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .sig-box { width: 280px; text-align: center; } /* Augmenté de 220px à 280px */
        .sig-label { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 15px; }
        .sig-line { border-top: 1px solid #000; padding-top: 8px; font-size: 10px; font-weight: 600; }
        .sig-img { max-height: 120px; max-width: 240px; object-fit: contain; margin-bottom: 5px; } /* Nouvelle classe pour l'image */

        /* FOOTER */
        .footer {
            border-top: 1px solid #000;
            padding-top: 15px; /* Réduit de 25px */
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .footer-col h4 { font-size: 8px; font-weight: 900; text-transform: uppercase; margin-bottom: 5px; color: #000; } /* Réduit */
        .footer-col p { font-size: 9px; color: var(--secondary); margin-bottom: 2px; line-height: 1.3; } /* Réduit */
        .footer-bottom {
            grid-column: span 3;
            text-align: center;
            margin-top: 10px; /* Réduit de 20px */
            font-size: 8px; /* Réduit de 9px */
            color: var(--muted);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="page-controls no-print">
        <button onclick="window.location.href='/invoices'" class="btn-action btn-return">Retour</button>
        <button onclick="window.print()" class="btn-action btn-print">Imprimer la Facture</button>
    </div>

    <div class="container-a4">
        <!-- HEADER -->
        <div class="header">
            <div class="brand">
                {% set _logo = settings.logo or settings.logo_path %}
                {% if _logo %}
                    <img src="{{ _logo }}" alt="Logo" style="max-height: 100px; max-width: 300px; object-fit: contain; margin-bottom: 5px;">
                {% else %}
                    <h1>{{ settings.company_name or 'TECHZONE' }}</h1>
                {% endif %}
                <p style="margin-top: 10px;">Solutions Technologiques & Mobiles</p>
            </div>
            <div class="doc-meta">
                <div class="doc-title">Facture</div>
                <div class="doc-id">#{{ invoice.invoice_number }}</div>
                <div class="doc-date">{{ invoice.date | format_date }}</div>
            </div>
        </div>

        <!-- INFO GRID -->
        <div class="info-grid">
            <div class="client-details">
                <div class="info-section-title">Facturé à</div>
                {% if invoice.client %}
                    <div class="client-name">{{ invoice.client.name }}</div>
                    <p>{{ invoice.client.address or 'Adresse non spécifiée' }}</p>
                    <p>Tél: {{ invoice.client.phone or '-' }}</p>
                    <p>{{ invoice.client.email or '' }}</p>
                {% else %}
                    <div class="client-name">Client Comptant</div>
                {% endif %}
            </div>
            <div class="payment-card">
                <div class="info-section-title">Détails de paiement</div>
                <div class="payment-item">
                    <span class="payment-label">Mode de règlement</span>
                    <span class="payment-value">{{ invoice.payment_method or 'Espèces' }}</span>
                </div>
                <div class="payment-item">
                    <span class="payment-label">État de la facture</span>
                    <span class="payment-value" style="text-transform: uppercase; color: {{ '#059669' if invoice.status == 'payée' else '#dc2626' }};">{{ invoice.status }}</span>
                </div>
                {% if invoice.due_date %}
                <div class="payment-item">
                    <span class="payment-label">Date d'échéance</span>
                    <span class="payment-value">{{ invoice.due_date | format_date }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ITEMS TABLE -->
        <div class="items-container">
            <table>
                <thead>
                    <tr>
                        <th class="col-desc">Description</th>
                        <th class="col-qty">Qté</th>
                        <th class="col-price">Prix Unitaire</th>
                        <th class="col-total">Total HT</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in grouped_items %}
                    {% if not item.is_section %}
                    <tr>
                        <td class="col-desc">
                            <div class="item-name">{{ item.name }}</div>
                            {% if item.imeis %}
                                <div class="item-imei">IMEI: {{ item.imeis | join(', ') }}</div>
                            {% endif %}
                        </td>
                        <td class="col-qty">{{ item.qty }}</td>
                        <td class="col-price">{{ item.price | format_cfa }}</td>
                        <td class="col-total">{{ item.total | format_cfa }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- SUMMARY -->
        <div class="summary-block">
            <div class="totals-table">
                <div class="total-row">
                    <span>Sous-total</span>
                    <span>{{ (invoice.subtotal or 0) | format_cfa }}</span>
                </div>
                {% if invoice.show_tax %}
                <div class="total-row">
                    <span>TVA ({{ (invoice.tax_rate or 18)|int }}%)</span>
                    <span>{{ (invoice.tax_amount or 0) | format_cfa }}</span>
                </div>
                {% endif %}
                <div class="total-row grand">
                    <span>TOTAL TTC</span>
                    <span>{{ (invoice.total or 0) | format_cfa }}</span>
                </div>
                {% if (invoice.paid_amount or 0) > 0 %}
                <div class="total-row highlight">
                    <span>Montant payé</span>
                    <span>{{ invoice.paid_amount | format_cfa }}</span>
                </div>
                <div class="total-row" style="color: #dc2626; font-weight: 800;">
                    <span>Reste à payer</span>
                    <span>{{ (invoice.total - invoice.paid_amount) | format_cfa }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- SIGNATURE -->
        <div class="signature-area">
            <div class="sig-box">
                <div class="sig-label">Signature & Cachet</div>
                {% if signature_data_url %}
                    <img src="{{ signature_data_url }}" class="sig-img">
                {% endif %}
                <div class="sig-line">Direction TECHZONE</div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div class="footer-col">
                <h4>Localisation</h4>
                <p>{{ settings.address or 'Dakar, Sénégal' }}</p>
                <p>{{ settings.city or '' }}</p>
            </div>
            <div class="footer-col" style="text-align: center;">
                <h4>Contact Direct</h4>
                <p>Tél: {{ settings.phone or '+221 77 000 00 00' }}</p>
                <p>Email: {{ settings.email or 'contact@techzone.sn' }}</p>
            </div>
            <div class="footer-col" style="text-align: right;">
                <h4>Services Web</h4>
                <p>Site: {{ settings.website or 'www.techzone.sn' }}</p>
                <p>Instagram: @techzone_sn</p>
            </div>
            <div class="footer-bottom">
                {{ settings.footer_text or 'TECHZONE - Votre partenaire en technologie de confiance.' }}
            </div>
        </div>
    </div>
</body>
</html>