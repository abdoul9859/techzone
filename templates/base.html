<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% set _gs = global_settings or {} %}
    {% set _comp = _gs.company if _gs.company is defined else {} %}
    {% set _app_name = _gs.name or _gs.company_name or (_comp.companyName if _comp is defined else None) or (_comp.name if _comp is defined else None) or 'TECHZONE' %}
    <title>{% block title %}{{ _app_name }}{% endblock %}</title>
    {% set _favicon = _gs.favicon if (_gs is defined and _gs.favicon) else None %}
    {% if _favicon %}
    <link rel="icon" href="{{ _favicon }}?v={{ ASSET_VERSION() }}">
    <link rel="shortcut icon" href="{{ _favicon }}?v={{ ASSET_VERSION() }}">
    {% else %}
    <link rel="icon" href="/static/favicon.ico?v={{ ASSET_VERSION() }}">
    <link rel="shortcut icon" href="/static/favicon.ico?v={{ ASSET_VERSION() }}">
    {% endif %}
    
    <!-- Google Fonts - Anybody -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anybody:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons (primary CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Bootstrap Icons (fallback CDN) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" crossorigin="anonymous">
    <script>
      (function(){
        function ensureBootstrapIcons(){
          try {
            var probe = document.createElement('i');
            probe.className = 'bi';
            document.body.appendChild(probe);
            var famBefore = getComputedStyle(probe, '::before').fontFamily || '';
            var fam = getComputedStyle(probe).fontFamily || '';
            probe.remove();
            if(!/bootstrap-icons/i.test(famBefore+fam)){
              var link = document.createElement('link');
              link.rel = 'stylesheet';
              link.href = 'https://unpkg.com/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css';
              link.crossOrigin = 'anonymous';
              document.head.appendChild(link);
            }
          } catch(e){}
        }
        document.addEventListener('DOMContentLoaded', ensureBootstrapIcons);
      })();
    </script>
    <!-- Custom CSS -->
    <link href="/static/css/style.css?v={{ ASSET_VERSION() }}" rel="stylesheet">

    <style>
        /* Padding pour compenser la navbar fixe */
        body#app-body {
            padding-top: 88px;
        }
        
        /* Ajustement pour les écrans plus petits */
        @media (max-width: 991.98px) {
            body#app-body {
                padding-top: 78px;
            }
        }
        /* Mode embarqué (iframe) : pas de navbar, pas de padding top */
        body#app-body.embedded {
            padding-top: 0 !important;
        }
        body#app-body.embedded > nav.navbar {
            display: none !important;
        }
        .app-container {
            max-width: 100% !important;
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }

        /* Optimisation Navbar */
        .navbar {
            overflow: visible !important;
            z-index: 1030;
        }
        .navbar-brand img {
            max-height: 38px;
            max-width: 180px;
            width: auto;
            object-fit: contain;
        }
        .nav-link {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
            font-size: 0.85rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }
        .navbar-nav .dropdown-menu {
            font-size: 0.9rem;
        }
        .navbar-nav {
            align-items: center;
        }

        /* Dropdowns de recherche navbar */
        #navSearchContainer .input-group {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: visible !important;
        }
        #navSearchContainer .form-control {
            color: white !important;
        }
        #navSearchContainer .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        #navSearchContainer .input-group:focus-within {
            background-color: white;
            border-color: #fff;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.25);
        }
        #navSearchContainer .input-group:focus-within .form-control {
            color: #212529 !important;
        }
        #navSearchContainer .input-group:focus-within .input-group-text,
        #navSearchContainer .input-group:focus-within .bi {
            color: var(--primary-color) !important;
        }
        
        #navSearchContainer .input-group-text, 
        #navSearchContainer .form-control, 
        #navSearchContainer .btn {
            border: none !important;
            background: transparent !important;
            color: inherit !important;
        }
        #navSearchContainer .btn:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
        #navSearchContainer .bi {
            color: rgba(255, 255, 255, 0.8);
        }
        #navSearchContainer .form-control:focus {
            box-shadow: none !important;
        }
        #navSearchContainer .dropdown-menu {
            position: absolute !important;
            top: calc(100% + 8px) !important;
            left: 0 !important;
            right: 0 !important;
            margin-top: 0 !important;
            transform: none !important;
            display: none !important;
            min-width: 100% !important;
            width: 100% !important;
            background-color: white !important;
            border: 1px solid #dee2e6 !important;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
            z-index: 9999 !important;
            max-height: 400px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }
        #navSearchContainer .dropdown-menu.show {
            display: block !important;
        }
        .border-bottom-light {
            border-bottom: 1px solid rgba(0,0,0,0.05) !important;
        }
        .border-bottom-light:last-child {
            border-bottom: none !important;
        }
        #navSearchContainer .dropdown-item:hover {
            background-color: rgba(31,41,55,0.04);
        }
        #navSearchContainer .dropdown-item:hover .text-dark {
            color: var(--primary-color) !important;
        }

        /* Masquer le texte des icônes sur les résolutions intermédiaires si besoin */
        @media (max-width: 1400px) {
            .nav-link span.d-xl-inline { display: none; }
            #navSearchContainer .input-group { max-width: 180px !important; }
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body id="app-body">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container app-container px-3 px-lg-5">
            <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="/">
                {% set _logo_global = (global_settings.logo or global_settings.logo_path) if global_settings is defined else None %}
                {% if _logo_global %}
                    <img src="{{ _logo_global }}" alt="Logo" />
                {% else %}
                    <i class="bi bi-gear-fill"></i>
                    <span>TECHZONE</span>
                {% endif %}
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- Dashboard -->
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-house-fill me-1"></i><span class="d-xl-inline">Dashboard</span>
                        </a>
                    </li>
                    
                    <!-- Gestion des stocks -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-boxes me-1"></i><span class="d-xl-inline">Stock</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/products">
                                <i class="bi bi-box-seam me-2"></i>Produits
                            </a></li>
                            <li><a class="dropdown-item" href="/scan">
                                <i class="bi bi-qr-code-scan me-2"></i>Scanner Codes-barres
                            </a></li>
                        </ul>
                    </li>
                    
                    <!-- Ventes -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-cart3 me-1"></i><span class="d-xl-inline">Ventes</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/clients">
                                <i class="bi bi-people-fill me-2"></i>Clients
                            </a></li>
                            <li><a class="dropdown-item" href="/quotations">
                                <i class="bi bi-file-earmark-text me-2"></i>Devis
                            </a></li>
                            <li><a class="dropdown-item" href="/invoices">
                                <i class="bi bi-receipt me-2"></i>Factures
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/daily-requests">
                                <i class="bi bi-chat-dots me-2"></i>Demandes Clients
                            </a></li>
                            <li><a class="dropdown-item" href="/daily-sales">
                                <i class="bi bi-cart-check me-2"></i>Ventes Quotidiennes
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/debts">
                                <i class="bi bi-credit-card me-2"></i>Créances Clients
                            </a></li>
                        </ul>
                    </li>
                    
                    <!-- Achats -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-truck me-1"></i><span class="d-xl-inline">Achats</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/supplier-invoices">
                                <i class="bi bi-receipt-cutoff me-2"></i>Factures Fournisseur
                            </a></li>
                            <li><a class="dropdown-item" href="/daily-purchases">
                                <i class="bi bi-basket2-fill me-2"></i>Achats quotidiens
                            </a></li>
                            <li class="admin-only" style="display: none;"><hr class="dropdown-divider"></li>
                            <li class="admin-only" style="display: none;"><a class="dropdown-item" href="/debts">
                                <i class="bi bi-credit-card-2-back me-2"></i>Dettes Fournisseur
                            </a></li>
                        </ul>
                    </li>
                    
                    <!-- Finances -->
                    <li class="nav-item dropdown admin-only" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-calculator me-1"></i><span class="d-xl-inline">Finances</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/bank-transactions">
                                <i class="bi bi-bank me-2"></i>Transactions Bancaires
                            </a></li>
                            <li><a class="dropdown-item" href="/reports">
                                <i class="bi bi-graph-up me-2"></i>Rapports
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/daily-recap">
                                <i class="bi bi-calendar-day me-2"></i>Récap Quotidien
                            </a></li>
                        </ul>
                    </li>
                    
                    <!-- Maintenance -->
                    <li class="nav-item">
                        <a class="nav-link" href="/maintenances">
                            <i class="bi bi-wrench-adjustable me-1"></i><span class="d-xl-inline">Maintenance</span>
                        </a>
                    </li>
                    
                    <!-- Outils -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-tools me-1"></i><span class="d-xl-inline">Outils</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/guide">
                                <i class="bi bi-book me-2"></i>Guide Utilisateur
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/google-sheets-sync">
                                <i class="bi bi-table me-2"></i>Synchronisation Google Sheets
                            </a></li>
                            <li><a class="dropdown-item" href="/migration-manager">
                                <i class="bi bi-arrow-repeat me-2"></i>Migration de Données
                            </a></li>
                            <li><a class="dropdown-item" href="/cache-manager">
                                <i class="bi bi-hdd-stack me-2"></i>Gestionnaire Cache
                            </a></li>
                        </ul>
                    </li>
                </ul>
                
                <!-- Navbar searches: Clients and Products -->
                <form class="d-flex align-items-center gap-2 ms-auto me-3 position-relative" role="search" id="navSearchContainer" onsubmit="return false;" style="z-index: 1031;">
                    <div class="input-group input-group-sm position-relative" style="max-width: 220px;">
                        <span class="input-group-text px-2" id="navClientSearchIcon" style="cursor: pointer;">
                            <i class="bi bi-people"></i>
                        </span>
                        <input class="form-control px-1" 
                               type="search" 
                               placeholder="Client..." 
                               aria-label="Recherche client" 
                               id="navClientSearch" 
                               autocomplete="off">
                        <button class="btn btn-sm p-0 px-2" id="navClientSearchBtn" type="button" title="Rechercher">
                            <i class="bi bi-search" style="font-size: 0.85rem; color: white;"></i>
                        </button>
                        <div class="dropdown-menu shadow-lg border-0 py-2" id="navClientDropdown" style="width:100%; max-height: 400px; overflow-x: hidden; overflow-y: auto; z-index: 9999; border-radius: 12px; display: none;"></div>
                    </div>
                    <div class="input-group input-group-sm position-relative" style="max-width: 220px;">
                        <span class="input-group-text px-2" id="navProductSearchIcon" style="cursor: pointer;">
                            <i class="bi bi-box"></i>
                        </span>
                        <input class="form-control px-1" 
                               type="search" 
                               placeholder="Produit..." 
                               aria-label="Recherche produit" 
                               id="navProductSearch" 
                               autocomplete="off">
                        <button class="btn btn-sm p-0 px-2" id="navProductSearchBtn" type="button" title="Rechercher">
                            <i class="bi bi-search" style="font-size: 0.85rem; color: white;"></i>
                        </button>
                        <div class="dropdown-menu shadow-lg border-0 py-2" id="navProductDropdown" style="width:100%; max-height: 400px; overflow-x: hidden; overflow-y: auto; z-index: 9999; border-radius: 12px; display: none;"></div>
                    </div>
                </form>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/settings" title="Paramètres">
                            <i class="bi bi-gear-fill me-1"></i><span class="d-xl-inline">Paramètres</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i><span id="username" class="d-xl-inline">Utilisateur</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right me-1"></i>Déconnexion
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="container app-container py-4 px-3 px-lg-5">
        <!-- Alertes (toast/alerts au-dessus des modals) -->
        <div id="alerts-container" class="position-fixed top-0 end-0 p-3" style="z-index: 20000; width: 360px;"></div>
        
        {% block content %}{% endblock %}
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Client HTTP léger (remplace Axios) -->
    <script src="/static/js/http.js?v={{ ASSET_VERSION() }}"></script>
    <!-- JsBarcode pour l'affichage/imp. des codes-barres -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Custom JS -->
    <script src="/static/js/auth.js?v={{ ASSET_VERSION() }}"></script>
    <script src="/static/js/utils.js?v={{ ASSET_VERSION() }}"></script>
    <script src="/static/js/storage.js?v={{ ASSET_VERSION() }}"></script>
    
    <script>
      // Wire navbar searches to pages with query param ?q=
      document.addEventListener('DOMContentLoaded', function() {
        // Détecter le mode embarqué pour cacher la navbar et le padding
        try {
          const qp = new URLSearchParams(window.location.search);
          const isEmbed = qp.get('embed') === '1' || (window.top !== window.self);
          if (isEmbed) {
            document.body.classList.add('embedded');
          }
        } catch(e) {}

        // Afficher les éléments admin-only si l'utilisateur est admin
        function showAdminElements() {
          try {
            if (window.authManager && window.authManager.isAdmin()) {
              document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'block';
              });
            }
          } catch(e) {
            console.error('Erreur lors de la vérification du rôle:', e);
          }
        }
        
        // Vérifier immédiatement
        showAdminElements();
        
        // Revérifier après un court délai pour s'assurer que authManager.verifyAuth() est terminé
        setTimeout(showAdminElements, 100);
        setTimeout(showAdminElements, 500);

        const clientInput = document.getElementById('navClientSearch');
        const productInput = document.getElementById('navProductSearch');
        const clientMenu = document.getElementById('navClientDropdown');
        const productMenu = document.getElementById('navProductDropdown');

        // Helper function to escape HTML
        function escapeHtml(text) {
          if (typeof text !== 'string') return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        function go(path, q){
          const query = (q || '').trim();
          const url = query ? `${path}?q=${encodeURIComponent(query)}` : path;
          window.location.href = url;
        }

        // Helpers
        const debounce = (fn, wait=250) => {
          let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
        };
        const showMenu = (menu) => { 
          if (!menu) return;
          menu.classList.add('show');
          menu.style.display = 'block';
        };
        const hideMenu = (menu) => { 
          if (!menu) return;
          menu.classList.remove('show');
          menu.style.display = 'none';
        };
        const formatCurrency = (v) => {
          try { return new Intl.NumberFormat('fr-FR', { style:'currency', currency:'XOF', maximumFractionDigits:0 }).format(v||0); } catch { return (v||0)+' XOF'; }
        };
        const highlight = (text, q) => {
          if (!q) return text;
          const esc = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          return text.replace(new RegExp(esc, 'ig'), m => `<mark class="px-0">${m}</mark>`);
        };

        // Renderers
        function renderClientResults(items, q) {
          if (!clientMenu) return; 
          if (!items || items.length === 0) { 
            clientMenu.innerHTML = '<div class="px-3 py-2 text-muted small"><i class="bi bi-info-circle me-1"></i>Aucun client trouvé</div>'; 
            showMenu(clientMenu); 
            return; 
          }
          clientMenu.innerHTML = items.slice(0,8).map(c => {
            const name = highlight(escapeHtml(c.name || ''), q);
            const sub = [c.email, c.phone].filter(Boolean).join(' • ');
            return `<button type="button" class="dropdown-item d-flex align-items-center px-3 py-2 border-bottom-light" data-id="${c.client_id}" data-type="client">
                      <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; min-width: 32px;">
                        <i class="bi bi-person"></i>
                      </div>
                      <div class="d-flex flex-column overflow-hidden">
                        <span class="fw-semibold text-truncate text-dark">${name}</span>
                        ${sub ? `<small class="text-muted text-truncate">${escapeHtml(sub)}</small>`: ''}
                      </div>
                    </button>`;
          }).join('');
          showMenu(clientMenu);
        }
        function renderProductResults(items, q) {
          if (!productMenu) return;
          if (!items || items.length === 0) { 
            productMenu.innerHTML = '<div class="px-3 py-2 text-muted small"><i class="bi bi-info-circle me-1"></i>Aucun produit trouvé</div>'; 
            showMenu(productMenu); 
            return; 
          }
          productMenu.innerHTML = items.slice(0,8).map(p => {
            const name = highlight(escapeHtml(p.name || ''), q);
            const sub = [p.category, p.brand, p.model].filter(Boolean).join(' • ');
            const hasVariants = Array.isArray(p.variants) && p.variants.length > 0;
            const availableVariants = hasVariants ? (p.variants || []).filter(v => !v.is_sold).length : 0;
            const inStock = hasVariants ? (availableVariants > 0) : ((p.quantity || 0) > 0);
            
            return `<button type="button" class="dropdown-item d-flex align-items-center px-3 py-2 border-bottom-light" data-id="${p.product_id}" data-type="product">
                      <div class="rounded-circle ${inStock ? 'bg-success' : 'bg-danger'} bg-opacity-10 ${inStock ? 'text-success' : 'text-danger'} d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; min-width: 32px;">
                        <i class="bi bi-box"></i>
                      </div>
                      <div class="d-flex flex-column flex-grow-1 overflow-hidden">
                        <div class="d-flex justify-content-between align-items-center gap-2">
                          <span class="fw-semibold text-truncate text-dark">${name}</span>
                          <span class="badge ${inStock ? 'bg-success' : 'bg-danger'} bg-opacity-10 ${inStock ? 'text-success' : 'text-danger'} border-0" style="font-size: 0.65rem;">
                            ${inStock ? 'En stock' : 'Rupture'}
                          </span>
                        </div>
                        ${sub ? `<small class="text-muted text-truncate">${escapeHtml(sub)}</small>`: ''}
                      </div>
                    </button>`;
          }).join('');
          showMenu(productMenu);
        }

        // Fetchers
        const fetchClients = debounce(async (q) => {
          try {
            if (!q || q.trim().length < 2) { hideMenu(clientMenu); return; }
            // Utiliser le paramètre search de l'API pour une recherche côté serveur
            const params = new URLSearchParams({ limit: 50, search: q });
            const axios = window.axios || window.api;
            if (!axios) {
              console.error('HTTP client not available');
              return;
            }
            const response = await axios.get(`/api/clients/?${params.toString()}`);
            const data = response.data || {};
            const list = data.items || data || [];
            renderClientResults(list, q);
          } catch(e) {
            console.error('Erreur lors de la recherche de clients:', e);
            if (clientMenu) {
              clientMenu.innerHTML = '<div class="dropdown-item text-danger small px-3 py-2">Erreur chargement</div>';
              showMenu(clientMenu);
            }
          }
        }, 250);

        const fetchProducts = debounce(async (q) => {
          try {
            if (!q || q.trim().length < 2) { hideMenu(productMenu); return; }
            const params = new URLSearchParams({ limit: 20, search: q });
            const axios = window.axios || window.api;
            if (!axios) {
              console.error('HTTP client not available');
              return;
            }
            const resp = await axios.get(`/api/products?${params.toString()}`);
            const items = resp.data || [];
            renderProductResults(items, q);
          } catch(e) {
            console.error('Erreur lors de la recherche de produits:', e);
            if (productMenu) {
              productMenu.innerHTML = '<div class="dropdown-item text-danger small px-3 py-2">Erreur chargement</div>';
              showMenu(productMenu);
            }
          }
        }, 250);

        const clientBtn = document.getElementById('navClientSearchBtn');
        const productBtn = document.getElementById('navProductSearchBtn');

        if (clientInput) {
          if (clientBtn) {
            clientBtn.addEventListener('click', () => {
              const value = clientInput.value || '';
              if (value.trim().length >= 2) {
                go('/clients', value);
              } else {
                fetchClients(value);
              }
            });
          }
          clientInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter') { 
              e.preventDefault(); 
              go('/clients', clientInput.value); 
            } 
          });
          clientInput.addEventListener('input', () => {
            const value = clientInput.value || '';
            if (value.trim().length >= 2) {
              fetchClients(value);
            } else {
              hideMenu(clientMenu);
            }
          });
          clientInput.addEventListener('focus', () => { 
            const value = clientInput.value || '';
            if (value.trim().length >= 2) fetchClients(value); 
          });
        }
        if (productInput) {
          if (productBtn) {
            productBtn.addEventListener('click', () => {
              const value = productInput.value || '';
              if (value.trim().length >= 2) {
                go('/products', value);
              } else {
                fetchProducts(value);
              }
            });
          }
          productInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter') { 
              e.preventDefault(); 
              go('/products', productInput.value); 
            } 
          });
          productInput.addEventListener('input', () => {
            const value = productInput.value || '';
            if (value.trim().length >= 2) {
              fetchProducts(value);
            } else {
              hideMenu(productMenu);
            }
          });
          productInput.addEventListener('focus', () => { 
            const value = productInput.value || '';
            if (value.trim().length >= 2) fetchProducts(value); 
          });
        }

        // Click handling on dropdowns
        function handleMenuClick(ev) {
          const btn = ev.target.closest('.dropdown-item');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          const type = btn.getAttribute('data-type');
          if (type === 'client') {
            window.location.href = `/clients/detail?id=${encodeURIComponent(id)}`;
          } else if (type === 'product') {
            // Redirige vers la page produits et ouvre le détail via paramètre
            const q = (productInput && productInput.value) ? `&q=${encodeURIComponent(productInput.value)}` : '';
            window.location.href = `/products?selected=${encodeURIComponent(id)}${q}`;
          }
        }
        if (clientMenu) clientMenu.addEventListener('click', handleMenuClick);
        if (productMenu) productMenu.addEventListener('click', handleMenuClick);

        // Close menus on outside click or escape
        document.addEventListener('click', (e) => {
          if (!e.target.closest('#navSearchContainer')) { hideMenu(clientMenu); hideMenu(productMenu); }
        });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { hideMenu(clientMenu); hideMenu(productMenu); } });
      });
    </script>
    <script>
      (function(){
        try{
          if (document.body && document.body.classList.contains('embedded')) return;
          var lastV = '{{ ASSET_VERSION() }}';
          function reloadWith(v){
            try{
              if ('caches' in window) {
                caches.keys().then(function(keys){ keys.forEach(function(k){ caches.delete(k); }); });
              }
            }catch(e){}
            try{
              var u = new URL(window.location.href);
              u.searchParams.set('__v', v);
              window.location.replace(u.toString());
            }catch(e){ window.location.reload(); }
          }
          function tick(){
            fetch('/__live/version', {cache:'no-store'}).then(function(r){return r.json();}).then(function(j){
              var v = j && j.v ? String(j.v) : null;
              if (v && v !== lastV){ reloadWith(v); }
            }).catch(function(){});
          }
          setInterval(tick, 2000);
        }catch(e){}
      })();
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
